@model Municipal_services_app.Models.EventsIndexViewModel

<div class="container mt-3">

    <!-- Toggle Tabs -->
    <div class="d-flex justify-content-center mb-4">
        <button id="btn-events" class="tab-btn active">
            Events <span class="badge badge-count">@Model.Events.Count</span>
        </button>
        <button id="btn-announcements" class="tab-btn">
            Announcements <span class="badge badge-count">@Model.Announcements.Count</span>
        </button>
    </div>

    <!-- Search + Filters Horizontal -->
    <div id="filters-section" class="mb-4 d-flex flex-wrap gap-2 align-items-center">
        <input type="text" id="searchInput" class="form-control flex-grow-1" placeholder="Search events..." value="@Model.Query" />

        <select id="categorySelect" class="form-select">
            <option value="">All Categories</option>
            @foreach (var cat in Model.Categories)
            {
                @if (Model.SelectedCategory == cat)
                {
                    <option value="@cat" selected>@cat</option>
                }
                else
                {
                    <option value="@cat">@cat</option>
                }
            }
        </select>

        <input type="date" id="fromDate" class="form-control" value="@(Model.From?.ToString("yyyy-MM-dd") ?? "")" />
        <input type="date" id="toDate" class="form-control" value="@(Model.To?.ToString("yyyy-MM-dd") ?? "")" />
    </div>

    <!-- Events Section -->
    <div id="events-section">
        <h3 class="section-title">Upcoming Events</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="eventsContainer">
            @foreach (var ev in Model.Events)
            {
                <div class="col event-item" data-title="@ev.Title" data-category="@ev.Category" data-date="@ev.Date.ToString("yyyy-MM-dd")">
                    <div class="card card-event h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">@ev.Title</h5>
                            <p class="card-text">@ev.Description</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <small>@ev.Date.ToString("dd MMM yyyy")</small>
                            <span class="badge badge-category">@ev.Category</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Announcements Section -->
    <div id="announcements-section" style="display:none;">
        <h3 class="section-title">Announcements</h3>
        <div class="row row-cols-1 row-cols-md-2 g-3">
            @foreach (var ann in Model.Announcements)
            {
                <div class="col">
                    <div class="card card-announcement h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">@ann.Title</h5>
                            <p class="card-text">@ann.Message</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <small>@ann.DatePosted.ToString("dd MMM yyyy")</small>
                            <span class="badge badge-category">@ann.Category</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Recommendations Section -->
    <div id="recommendations-section" style="display:none;" class="mt-4">
        <h3 class="section-title">Recommended for you</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="recommendationsContainer">
            @* Rempli par JS dynamiquement *@
        </div>
    </div>
</div>

<script>
    // --- Tab toggle ---
    const btnEvents = document.getElementById('btn-events');
    const btnAnnouncements = document.getElementById('btn-announcements');
    const eventsSection = document.getElementById('events-section');
    const announcementsSection = document.getElementById('announcements-section');

    btnEvents.addEventListener('click', () => {
        btnEvents.classList.add('active');
        btnAnnouncements.classList.remove('active');
        eventsSection.style.display = 'block';
        announcementsSection.style.display = 'none';
    });

    btnAnnouncements.addEventListener('click', () => {
        btnAnnouncements.classList.add('active');
        btnEvents.classList.remove('active');
        eventsSection.style.display = 'none';
        announcementsSection.style.display = 'block';
    });

    // --- Live search + recommendations ---
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const eventsContainer = document.getElementById('eventsContainer');
    const recommendationsSection = document.getElementById('recommendations-section');
    const recommendationsContainer = document.getElementById('recommendationsContainer');

    const eventItems = Array.from(document.querySelectorAll('.event-item'));
    const searchQueue = []; // queue pour stocker dernières recherches
    const MAX_QUEUE = 3; // on garde les 3 dernières recherches

    function filterEvents() {
        const searchTerm = searchInput.value.toLowerCase();
        const category = categorySelect.value;
        const from = fromDate.value;
        const to = toDate.value;

        // stocker dans la queue si non vide
        if (searchTerm.trim() !== "") {
            searchQueue.push(searchTerm);
            if (searchQueue.length > MAX_QUEUE) searchQueue.shift(); // FIFO
        }

        // Filtrer events
        let filtered = eventItems.filter(item => {
            const title = item.dataset.title.toLowerCase();
            const itemCategory = item.dataset.category;
            const date = item.dataset.date;

            const matchesTitle = title.includes(searchTerm);
            const matchesCategory = category === "" || itemCategory === category;
            const matchesFrom = !from || date >= from;
            const matchesTo = !to || date <= to;

            return matchesTitle && matchesCategory && matchesFrom && matchesTo;
        });

        // Afficher/Masquer events
        eventItems.forEach(item => item.style.display = filtered.includes(item) ? 'block' : 'none');

        // --- Recommandations dynamiques ---
        if (searchQueue.length > 0) {
            recommendationsSection.style.display = 'block';
            recommendationsContainer.innerHTML = "";

            // calcul simple: prend les termes les plus fréquents dans la queue
            const freqMap = {};
            searchQueue.forEach(term => {
                freqMap[term] = (freqMap[term] || 0) + 1;
            });
            const topTerm = Object.entries(freqMap).sort((a,b)=>b[1]-a[1])[0][0];

            // afficher top 5 éléments correspondant au topTerm
            const recs = eventItems.filter(item => item.dataset.title.toLowerCase().includes(topTerm)).slice(0,5);
            recs.forEach(item => recommendationsContainer.appendChild(item.cloneNode(true)));
        } else {
            recommendationsSection.style.display = 'none';
        }
    }

    // Events triggers
    searchInput.addEventListener('input', filterEvents);
    categorySelect.addEventListener('change', filterEvents);
    fromDate.addEventListener('change', filterEvents);
    toDate.addEventListener('change', filterEvents);

    // initial call pour recommandations si page reload
    filterEvents();
</script>
